---
import ImageOffIcon from "@/assets/icons/image-off.svg"
import Adsense from "@/components/ad/adsense.astro"
import GenreListSingleMovie from "@/components/genre/genre-list-single-movie.astro"
import RelatedMovies from "@/components/movie/related-movies.astro"
import ProductionCompanyListSingleMovie from "@/components/production-company/production-company-list-single-movie.astro"
import BreadcrumbSchema from "@/components/seo/breadcrumb-schema.astro"
import MovieSchema from "@/components/seo/movie-schema.astro"
import MainLayout from "@/layouts/main-layout.astro"
import type {
  SelectGenre,
  SelectMovie,
  SelectProductionCompany,
} from "@/server/db/schema"
import { api } from "@/trpc/server"

const { slug } = Astro.params

const movieData = await api.movie.bySlug(slug!)

if (!movieData) {
  return Astro.redirect("/404")
}

const movie = movieData as SelectMovie & {
  overview?: string
  genres: Pick<SelectGenre, "id" | "slug" | "title">[]
  productionCompanies: Pick<SelectProductionCompany, "id" | "slug" | "name">[]
}

const genres = movie.genres
const productionCompanies = movie.productionCompanies

const relatedMovies = (await api.movie.related({
  currentMovieId: movie.id,
  genreId: movie.genres[0].id,
  limit: 6,
})) as (SelectMovie & {
  genres: {
    movieId: string
    genreId: string
  }[]
})[]

// Prepare movie data for schema
const movieForSchema = {
  ...movie,
  overview: movie.overview ?? null,
  genres: movie.genres.map((g) => ({ title: g.title })),
}
---

<MainLayout title={movie.title} description={movie.overview ?? movie.title}>
  <div class="space-y-6">
    <h1 class="text-2xl font-bold md:text-3xl">{movie.title}</h1>
    {
      movie.poster ? (
        <div class="flex items-center justify-center">
          <img
            src={movie.poster}
            alt={movie.title}
            width="300px"
            height="450px"
            loading="lazy"
            sizes="(min-width: 640px) 300px, 150px"
            class="aspect-[2/3] rounded object-cover"
          />
        </div>
      ) : (
        <ImageOffIcon class="aspect-[2/3] h-auto w-full" />
      )
    }
    <Adsense adSlot="2718001982" />
    <p>
      {movie.overview}
    </p>
    <Adsense adSlot="3924401743" />
    <ProductionCompanyListSingleMovie
      productionCompanies={productionCompanies}
    />
    <GenreListSingleMovie genres={genres} />
    <RelatedMovies movies={relatedMovies} />
  </div>
  <MovieSchema movie={movieForSchema} />
  <BreadcrumbSchema
    listItems={[
      {
        name: "Film",
        url: "/movie",
      },
      {
        name: genres[0].title,
        url: `/genre/${genres[0].slug}`,
      },
      {
        name: movie.title,
        url: `/movie/${movie.slug}`,
      },
    ]}
  />
</MainLayout>
